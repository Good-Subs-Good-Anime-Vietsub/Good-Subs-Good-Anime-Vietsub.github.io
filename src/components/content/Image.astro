---
import { Image as AstroImage } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  src: string;
  alt: string;
  [key: string]: any; // Cho phép các props khác
}

const { src, alt, ...props } = Astro.props;

// Lấy slug của bài viết hiện tại từ URL
const currentSlug = Astro.url.pathname.split('/anime/')[1]?.split('/')[0];

// Tìm tất cả các ảnh trong thư mục content/anime
const allContentImages = import.meta.glob('/src/content/anime/**/*.{jpg,jpeg,png,gif,webp}');

let imagePath: ImageMetadata | undefined;
for (const [key, value] of Object.entries(allContentImages)) {
  // Xây dựng đường dẫn tương đối của ảnh trong thư mục content
  // Ví dụ: /src/content/anime/ookamikodomo-2012/mittsu-main.png
  const expectedPath = `/src/content/anime/${currentSlug}/${src}`;
  if (key === expectedPath) {
    const imageModule = await value() as { default: ImageMetadata };
    imagePath = imageModule.default;
    break;
  }
}

if (!imagePath) {
  console.warn(`Image not found for slug "${currentSlug}" and src "${src}"`);
}
---

{imagePath ? (
  <AstroImage
    src={imagePath}
    alt={alt}
    class="w-full h-auto rounded-lg shadow-lg object-cover my-4"
    loading="lazy"
    decoding="async"
    {...props}
  />
) : (
  <p class="text-red-500">Error: Image "{src}" not found.</p>
)}
